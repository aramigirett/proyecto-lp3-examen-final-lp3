{% extends 'base.html' %}

{% block titulo %}
lp3
{% endblock %}

{% block contenido %}
<style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
    }

    h1 {
        color: #030505;
    }

    #controls {
        margin: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #month-select, #year-select, button {
        margin: 0 10px;
        padding: 10px;
        font-size: 13px;
        background-color: #297ba0;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    #calendar {
        margin: 20px auto;
        width: 80%;
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
    }

    .day, .day-header {
        padding: 10px;
        box-sizing: border-box;
        border: 1px solid #ddd;
    }

    .day-header {
        font-weight: bold;
        background-color: #e0e0e0;
    }

    #event-form {
        margin-top: 20px;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    input, button {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        border: 1px solid #ccc;
    }

    .btn-block {
        display: block;
        width: 100%;
    }

    .modify-btn {
        background-color: #ffcc00;
        border: none;
        cursor: pointer;
        padding: 5px 10px;
        margin-top: 5px;
        border-radius: 5px;
    }
</style>

<body>

    <h1>AGENDA MÉDICA</h1>
    <div id="controls">
        <button id="prev-month">&lt;</button>
        <select id="month-select"></select>
        <select id="year-select"></select>
        <button id="next-month">&gt;</button>
    </div>

    <div id="calendar"></div>

    <div id="event-form">
        
        <form id="add-event-form">
            
            <a href="{{ url_for('formulario_paciente') }}" class="btn btn-info">Agendar Cita</a>
        </form>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
          const calendar = document.getElementById('calendar');
          const form = document.getElementById('add-event-form');
          const eventDate = document.getElementById('event-date');
          const eventName = document.getElementById('event-name');
          const monthSelect = document.getElementById('month-select');
          const yearSelect = document.getElementById('year-select');
          const prevMonthButton = document.getElementById('prev-month');
          const nextMonthButton = document.getElementById('next-month');

          let currentDate = new Date();
          let events = JSON.parse(localStorage.getItem('events')) || [];
          let currentEditIndex = null;

          // Inicializar el selector de meses y años
          const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
          monthNames.forEach((month, index) => {
              const option = document.createElement('option');
              option.value = index;
              option.textContent = month;
              monthSelect.appendChild(option);
          });

          const currentYear = currentDate.getFullYear();
          for (let i = currentYear - 50; i <= currentYear + 50; i++) {
              const option = document.createElement('option');
              option.value = i;
              option.textContent = i;
              if (i === currentYear) option.selected = true;
              yearSelect.appendChild(option);
          }

          monthSelect.value = currentDate.getMonth();
          yearSelect.value = currentYear;

          // Eventos para cambiar de mes/año
          monthSelect.addEventListener('change', updateCalendar);
          yearSelect.addEventListener('change', updateCalendar);
          prevMonthButton.addEventListener('click', () => changeMonth(-1));
          nextMonthButton.addEventListener('click', () => changeMonth(1));

          form.addEventListener('submit', function(event) {
              event.preventDefault();
              const date = new Date(eventDate.value);
              const name = eventName.value;

              if (date && name) {
                  if (currentEditIndex !== null) {
                      events[currentEditIndex] = { day: date.getDate(), month: date.getMonth(), year: date.getFullYear(), name };
                      currentEditIndex = null;
                  } else {
                      events.push({ day: date.getDate(), month: date.getMonth(), year: date.getFullYear(), name });
                  }
                  localStorage.setItem('events', JSON.stringify(events));
                  updateCalendar();
                  form.reset();
              } else {
                  alert('Por favor ingrese una fecha y nombre válido.');
              }
          });

          function changeMonth(delta) {
              let newMonth = parseInt(monthSelect.value) + delta;
              let newYear = parseInt(yearSelect.value);

              if (newMonth < 0) {
                  newMonth = 11;
                  newYear--;
              } else if (newMonth > 11) {
                  newMonth = 0;
                  newYear++;
              }

              monthSelect.value = newMonth;
              yearSelect.value = newYear;
              updateCalendar();
          }

          function updateCalendar() {
              const month = parseInt(monthSelect.value);
              const year = parseInt(yearSelect.value);
              calendar.innerHTML = '';

              // Días de la semana
              const weekdays = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
              weekdays.forEach(day => {
                  const dayHeader = document.createElement('div');
                  dayHeader.classList.add('day-header');
                  dayHeader.innerText = day;
                  calendar.appendChild(dayHeader);
              });

              const firstDay = new Date(year, month, 1).getDay();
              const daysInMonth = new Date(year, month + 1, 0).getDate();

              // Espacios vacíos para el inicio del mes
              for (let i = 0; i < firstDay; i++) {
                  const emptyDay = document.createElement('div');
                  emptyDay.classList.add('day');
                  calendar.appendChild(emptyDay);
              }

              // Días del mes
              for (let i = 1; i <= daysInMonth; i++) {
                  const day = document.createElement('div');
                  day.classList.add('day');
                  day.innerHTML = `<header>${i}</header>`;
                  calendar.appendChild(day);
              }

              // Mostrar eventos
              events.forEach((event, index) => {
                  if (event.month === month && event.year === year) {
                      const day = calendar.querySelector(`.day:nth-child(${event.day + firstDay + 7})`);
                      if (day) {
                          day.innerHTML += `<div>${event.name} <button class="modify-btn" data-index="${index}">Modificar</button></div>`;
                      }
                  }
              });

              // Botones de modificar
              document.querySelectorAll('.modify-btn').forEach(button => {
                  button.addEventListener('click', (e) => {
                      const index = e.target.getAttribute('data-index');
                      const eventToEdit = events[index];

                      eventDate.value = `${eventToEdit.year}-${String(eventToEdit.month + 1).padStart(2, '0')}-${String(eventToEdit.day).padStart(2, '0')}`;
                      eventName.value = eventToEdit.name;
                      currentEditIndex = index;  
                  });
              });
          }

          updateCalendar();
      });
    </script>
</body>
{% endblock %}